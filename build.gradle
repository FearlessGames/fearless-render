lwjglVersion = '2.8.3'

coreLibDir = new File("fearless-render-core/lib")

subprojects {
    apply plugin: 'java'
    group = "se.fearlessgames.fear"

    repositories {
        flatDir name: 'projectLibs', dirs: coreLibDir.absolutePath
        mavenCentral()
    }

    sourceCompatibility = 1.6

    defaultTasks 'build'

    test {
        maxParallelForks = 10
    }

    buildDir = "build"

    dependencies {

    }
}

dependsOnChildren()

// Find any 3rd party libraries which have released new versions
// to the central Maven repo since we last upgraded.
task checkLibVersions << {
    def checked = [:]
    allprojects {
        configurations.each { configuration ->
            configuration.allDependencies.each { dependency ->
                def version = dependency.version
                if (!version.contains('SNAPSHOT') && !checked[dependency]) {
                    def group = dependency.group
                    def path = group.replace('.', '/')
                    def name = dependency.name
                    def url = "http://repo1.maven.org/maven2/$path/$name/maven-metadata.xml"
                    try {
                        def metadata = new XmlSlurper().parseText(url.toURL().text)
                        def newestVersion = metadata.versioning.latest
                        //println "Latest version of $name is $newestVersion"

                        if (!version.toString().equals(newestVersion.toString())) {
                            println "$group:$name $version -> $newestVersion"
                        }
                    } catch (FileNotFoundException e) {
                        logger.debug "Unable to download $url: $e.message"
                    } catch (org.xml.sax.SAXParseException e) {
                        logger.debug "Unable to parse $url: $e.message"
                    }
                    checked[dependency] = true
                }
            }
        }
    }
}


final def LIBRARIES_ID = 'Fearless-renderer Libraries'
final def TEST_LIBRARIES_ID = 'Fearless-renderer Test Libraries'
final def IML_FILE = "fearless-render.iml"


task intellijSync << {
    description = 'Add gradle dependecies to IntelliJ project library'

    final def librariesDir = new File(".idea${File.separator}libraries")
    librariesDir.mkdirs()


    final def userHome = System.getProperty('user.home').replaceAll("\\\\", "/")
    final def projectDir = file('.').path.replaceAll("\\\\", "/").toString()

    println "Using projectDir = '$projectDir'"
    println "Using user.home = '$userHome'"

    def replacePath = { path ->
        path = path.replaceAll("\\\\", "/")
        path = path.replaceAll(projectDir, "\\\$PROJECT_DIR\\\$")
        path = path.replaceAll(userHome, "\\\$USER_HOME\\\$")
        return path;
    }

    def makeJarList = { path ->
        path.split(File.pathSeparator).collect {
            replacePath(it);
        }
    }

    final def compileJars = makeJarList(configurations.compile.asPath)
    final def testJars = makeJarList(configurations.testCompile.asPath) - compileJars

    def createLibrary = { fileName, libraryName, jars ->
        final def gradleLibXml = new File(librariesDir, fileName)
        gradleLibXml.write """
<component name="libraryTable">
  <library name="$libraryName"/>
</component>"""
        final def xmlRoot = new XmlParser().parse(gradleLibXml)
        final def classesNode = xmlRoot.library[0].appendNode('CLASSES')
        final def sourceNode = xmlRoot.library[0].appendNode('SOURCES')

        jars.each { jar ->
            classesNode.appendNode('root', [url: "jar://$jar!/"])
            def src = jar.replaceAll("/jar/", "/source/").replaceAll(".jar", "-sources.jar")
            sourceNode.appendNode('root', [url: "jar://$src!/"])
        }

        def writer = new StringWriter()
        new XmlNodePrinter(new PrintWriter(writer)).print(xmlRoot)
        gradleLibXml.write writer.toString()
        println "File '${gradleLibXml.path}' updated"
    }

    createLibrary LIBRARIES_ID.replaceAll(" ", "_").replaceAll("-", "_") + ".xml", LIBRARIES_ID, compileJars
    createLibrary TEST_LIBRARIES_ID.replaceAll(" ", "_").replaceAll("-", "_") + ".xml", TEST_LIBRARIES_ID, testJars
}

task intellijModuleSync(dependsOn: intellijSync) << {
    final def moduleFile = new File(IML_FILE)
    def root = new XmlParser().parse(moduleFile)
    def newModuleRootManager = root.component.find {it.'@name' == 'NewModuleRootManager'}

    def addEntry = { scope, entryName ->
        def orderEntry = newModuleRootManager.orderEntry.find {
            it.'@type' == 'library' && it.'@name' == entryName
        }
        if (orderEntry) {
            newModuleRootManager.remove(orderEntry)
        }

        newModuleRootManager.appendNode('orderEntry', [type: 'library', scope: scope, name: entryName, level: 'project'])
    }

    addEntry("", LIBRARIES_ID)
    addEntry("TEST", TEST_LIBRARIES_ID)



    def writer = new StringWriter()
    new XmlNodePrinter(new PrintWriter(writer)).print(root)
    moduleFile.write writer.toString()
    println "File '${moduleFile.path}' updated"
}

task wrapper(type: Wrapper) {
    gradleVersion = '1.0-milestone-7'
}